<div class="container">

    <!-- Page Heading -->
    <h1>Organisations<span *ngIf="!data">...</span></h1>

    <!-- Data Loading... (Spinner) -->
    <div *ngIf="!data">
        <mat-spinner></mat-spinner>
    </div>

    <!-- Data Loaded -->
    <div *ngIf="data">

        <!-- Column Options -->
        <div class="expansion-panel expansion-panel-column">
            <mat-accordion>
                <mat-expansion-panel>

                    <!-- Panel Header -->
                    <mat-expansion-panel-header>

                        <!-- Panel Title -->
                        <mat-panel-title>
                            Column Options
                        </mat-panel-title>

                        <!-- Panel Description -->
                        <mat-panel-description>

                            <!-- Settings Icon -->
                            <mat-icon>list</mat-icon>

                            Select columns to display on the table

                        </mat-panel-description>

                    </mat-expansion-panel-header>

                    <!-- Column Visibility Drop-Down List -->
                    <section class="example-section" [formGroup]="columnForm">
                        <div class="flex-container-1">
                            <mat-checkbox [formControlName]="item.columnId" *ngFor="let item of columnConfig" [value]="item.columnId" (change)="onCheckboxSelectionChange($event)">
                                {{ item.columnName }}
                            </mat-checkbox>
                        </div>
                    </section>

                </mat-expansion-panel>

            </mat-accordion>
        </div>

        <!-- Filter Options -->
        <div class="expansion-panel">
            <mat-accordion>
                <mat-expansion-panel>

                    <!-- Panel Header -->
                    <mat-expansion-panel-header>

                        <!-- Panel Title -->
                        <mat-panel-title>
                            Filter Options
                        </mat-panel-title>

                        <!-- Panel Description -->
                        <mat-panel-description>

                            <!-- Settings Icon -->
                            <mat-icon>filter_alt</mat-icon>

                            <!-- Organisation Name -->
                            <span *ngIf="orgNameInput.value">
                                Organisation Name:
                                <strong>
                                    {{ orgNameInput.value }}
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Role(s) -->
                            <span
                                *ngIf="roleInput.primaryRole.value.length + roleInput.nonPrimaryRole.value.length > 0">
                                Role<span
                                    *ngIf="roleInput.primaryRole.value.length + roleInput.nonPrimaryRole.value.length > 1">s</span>:
                                <strong>
                                    {{ (roleInput.primaryRole.value.concat(roleInput.nonPrimaryRole.value).slice(0,
                                    3)).join(', ') }}
                                    <span
                                        *ngIf="roleInput.primaryRole.value.concat(roleInput.nonPrimaryRole.value).length > 3">
                                        (plus {{
                                        roleInput.primaryRole.value.concat(roleInput.nonPrimaryRole.value).length - 3 }}
                                        more)
                                    </span>
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Status -->
                            <span *ngIf="statusInput.value">
                                Status:
                                <strong>
                                    {{ statusInput.value }}
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Postcode -->
                            <span *ngIf="postcodeInput.value">
                                Postcode:
                                <strong>
                                    {{ postcodeInput.value }}
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Last Updated -->
                            <span *ngIf="lastChangeDateInput.value">
                                Last Updated:
                                <strong>
                                    {{ lastChangeDateInput.value | date: 'dd MMM yyyy' }}
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Limit -->
                            <span>
                                Limit:
                                <strong>
                                    {{ limitInput.value | number }}
                                </strong>
                                &nbsp;|&nbsp;
                            </span>

                            <!-- Offset -->
                            <span>
                                Offset:
                                <strong>
                                    {{ offsetInput.value | number }}
                                </strong>
                            </span>

                        </mat-panel-description>

                    </mat-expansion-panel-header>

                    <!-- Filters -->
                    <form #dataOptionsForm="ngForm" (ngSubmit)="onSubmitForm()">

                        <div class="flex-container-2">

                            <!-- Organisation Name -->
                            <mat-form-field>
                                <mat-label>Organisation Name</mat-label>
                                <input matInput [formControl]="orgNameInput" placeholder="e.g. St. Mary's">
                                <button *ngIf="orgNameInput.value" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="orgNameInput.setValue(null)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Primary Role -->
                            <mat-form-field>
                                <mat-label>Primary Role</mat-label>
                                <mat-select [formControl]="roleInput.primaryRole" placeholder="Select role(s)" multiple
                                    panelClass="long-list">
                                    <mat-option *ngFor="let role of roles.primaryRoles?.Roles" [value]="role.id">
                                        {{ role.displayName }}
                                    </mat-option>
                                </mat-select>
                                <button *ngIf="roleInput.primaryRole.value.length > 0" matSuffix mat-icon-button
                                    aria-label="Clear" (click)="roleInput.primaryRole.setValue([])">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Non-Primary Role -->
                            <mat-form-field>
                                <mat-label>Non-Primary Role</mat-label>
                                <mat-select [formControl]="roleInput.nonPrimaryRole" placeholder="Select role(s)"
                                    multiple panelClass="long-list">
                                    <mat-option *ngFor="let role of roles.nonPrimaryRoles?.Roles" [value]="role.id">
                                        {{ role.displayName }}
                                    </mat-option>
                                </mat-select>
                                <button *ngIf="roleInput.nonPrimaryRole.value.length > 0" matSuffix mat-icon-button
                                    aria-label="Clear" (click)="roleInput.nonPrimaryRole.setValue([])">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Status -->
                            <mat-form-field>
                                <mat-label>Status</mat-label>
                                <mat-select [formControl]="statusInput" placeholder="Select a status">
                                    <mat-option [value]="null"></mat-option>
                                    <mat-option *ngFor="let s of status" [value]="s.id">
                                        {{ s.displayName }}
                                    </mat-option>
                                </mat-select>
                                <button *ngIf="statusInput.value" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="statusInput.setValue(null)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Postcode -->
                            <mat-form-field>
                                <mat-label>Postcode</mat-label>
                                <input matInput [formControl]="postcodeInput" minlength="2" maxlength="8"
                                    placeholder="E1 6AN" (input)="onPostcodeInput()"
                                    (dblclick)="onPostcodeDoubleClick()"
                                    matTooltip="Double click to enter current location outcode"
                                    matTooltipPosition="above">
                                <button *ngIf="postcodeInput.value" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="postcodeInput.setValue(null)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Last Updated -->
                            <mat-form-field>
                                <mat-label>Last Updated</mat-label>
                                <input matInput [min]="lastChangeDateConfig.min" [max]="lastChangeDateConfig.max"
                                    [matDatepicker]="picker" [formControl]="lastChangeDateInput"
                                    matTooltip="Double click to enter earliest date" matTooltipPosition="above"
                                    (dblclick)="onLastChangeDateDoubleClick()">
                                <mat-hint>Must be within the last 185 days</mat-hint>
                                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                                <button *ngIf="lastChangeDateInput.value" matSuffix mat-icon-button aria-label="Clear"
                                    (click)="lastChangeDateInput.setValue(null)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>

                            <!-- Offset -->
                            <mat-form-field>

                                <!-- Label -->
                                <mat-label>
                                    Offset
                                </mat-label>

                                <!-- Number Input -->
                                <input type="number" matInput required [formControl]="offsetInput"
                                    [min]="offsetConfig.min" [max]="offsetConfig.max">

                                <!-- Hint -->
                                <mat-hint>
                                    {{ offsetConfig.min | number }} to {{ offsetConfig.max | number }}
                                </mat-hint>

                                <!-- Error Messages -->
                                <mat-error *ngIf="offsetInput.hasError('min') || offsetInput.hasError('max')">
                                    Please enter a value between {{ offsetConfig.min | number }} and {{ offsetConfig.max
                                    | number }}
                                </mat-error>

                            </mat-form-field>

                            <!-- Limit -->
                            <mat-form-field>

                                <!-- Label -->
                                <mat-label>
                                    Limit
                                </mat-label>

                                <!-- Number Input -->
                                <input type="number" matInput required [formControl]="limitInput"
                                    [min]="limitConfig.min" [max]="limitConfig.max">

                                <!-- Hint -->
                                <mat-hint>
                                    {{ limitConfig.min | number }} to {{ limitConfig.max | number }}
                                </mat-hint>

                                <!-- Error Messages -->
                                <mat-error *ngIf="limitInput.hasError('min') || limitInput.hasError('max')">
                                    Please enter a value between {{ limitConfig.min | number }} and {{ limitConfig.max |
                                    number }}
                                </mat-error>

                            </mat-form-field>

                        </div>

                        <!--  Submit Button -->
                        <button mat-raised-button color="primary" [disabled]="filterForm.invalid">
                            Refresh Data
                        </button>

                        <!-- Error Messages -->
                        <mat-error *ngIf="filterForm.hasError('atLeastOneRequired')">
                            {{ filterForm.errors?.['atLeastOneRequired'] }}
                        </mat-error>

                    </form>

                </mat-expansion-panel>

            </mat-accordion>
        </div>

        <!-- URL -->
        <div class="expansion-panel">
            <mat-accordion>
                <mat-expansion-panel>

                    <!-- Panel Header -->
                    <mat-expansion-panel-header>

                        <!-- Panel Title -->
                        <mat-panel-title>
                            Show API Parameters
                        </mat-panel-title>

                        <!-- Panel Description -->
                        <mat-panel-description>

                            <mat-icon>cloud</mat-icon>

                            Records Returned: {{ data.Organisations.length | number }}

                        </mat-panel-description>

                    </mat-expansion-panel-header>

                    <div class="url-container">

                        <h3>Parameters</h3>
                        <p *ngFor="let item of urlObj.url.substr(urlObj.baseUrl.length + 1).split('&')">
                            {{ item.replaceAll('%2C', ', ').replace('=', ': ') }}
                        </p>

                        <h3>Full API</h3>
                        <a [href]="urlObj.url" target="_blank">{{ urlObj.url }}</a>

                    </div>

                </mat-expansion-panel>

            </mat-accordion>
        </div>

        <hr>

        <!-- No records exist -->
        <div *ngIf="data.Organisations.length === 0">
            <h3>No data matched your search criteria</h3>
        </div>

        <!-- Records exist -->
        <div *ngIf="data.Organisations.length > 0">

            <!-- Data Table -->
            <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>

                <!-- Column Definitions -->
                <ng-container [matColumnDef]="item.columnId" *ngFor="let item of columnConfig">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ item.columnName }}</th>
                    <td mat-cell *matCellDef="let organisation">{{ organisation[item.columnId] }}</td>
                </ng-container>

                <!-- Header Row -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>

                <!-- Data Rows -->
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="onRowClick(row)"></tr>
            </table>
        </div>

    </div>
</div>